<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0uaGV-62aAS74y5I-HVKCtGd8l5vy0iaNOErDHjQBFXNt2kDKhAEUMRQDGckqQoJqjUtwnKqTWqgR/pub?gid=0&single=true&output=csv";

let tableData = [];
let headers = [];
let currentSortColumn = -1;
let sortAscending = true;
let posIndex = -1;

const columnDescriptions = {
  "B#": "NFL Expert Brandon Armstrong's Big Board Ranking",
  "C#": "Consensus Ranking according to NFLMockDraftDatabase.com",
  "Name": "Player's Name",
  "POS": "Player's Primary Position",
  "School": "The university out of which the player is being drafted",
  "Height": "Player's Height",
  "Weight": "Player's Weight in pounds",
  "Age": "Player's Draft Age",
  "PFN": "Impact Score according to ProFootballNetwork.com",
  "PFF": "Grade for most recently played season according to ProFootballFocus.com",
  "NFLDB": "Draft Prospect Grade according to NFLDraftBuzz.com",
  "AVG": "Average of PFN, PFF & NFLDB (if available)"
};

Papa.parse(csvUrl, {
  download: true,
  complete: function(results) {

    headers = results.data[1];
    headers[0] = "B#";
    tableData = results.data.slice(2).filter(r => r.length > 1);

    posIndex = headers.findIndex(h =>
      h.toLowerCase().includes("pos")
    );

    createHeaders();
    populateFilter();
    displayRows();
  }
});

function createHeaders() {
  const thead = document.querySelector("#data-table thead");
  thead.innerHTML = "";
  const row = document.createElement("tr");

  headers.forEach((h, i) => {
    const th = document.createElement("th");
    const label = document.createElement("span");
    label.textContent = h;

    const arrow = document.createElement("span");
    arrow.className = "arrow";

    th.appendChild(label);
    th.appendChild(arrow);

    if (columnDescriptions[h]) {
      th.title = columnDescriptions[h];
    }

    th.onclick = () => {
      sortTable(i);
      updateArrows();
      highlightColumn();
    };

    row.appendChild(th);
  });

  thead.appendChild(row);
}

/* HEIGHT PARSER */
function parseHeight(val){
  if(!val) return 0;

  val = val.toString().trim();
  const match = val.match(/^(\d+)[-'](\d+(\.\d+)?)$/);

  if(match){
    return parseFloat(match[1]) * 12 + parseFloat(match[2]);
  }

  return parseFloat(val) || 0;
}

/* HAND / ARM PARSER */
function parseMeasurement(val){
  if(!val) return 0;

  val = val.toString().trim();

  let mixed = val.match(/^(\d+)\s+(\d+)\/(\d+)$/);
  if(mixed){
    return parseFloat(mixed[1]) +
           (parseFloat(mixed[2]) / parseFloat(mixed[3]));
  }

  let fraction = val.match(/^(\d+)\/(\d+)$/);
  if(fraction){
    return parseFloat(fraction[1]) /
           parseFloat(fraction[2]);
  }

  return parseFloat(val) || 0;
}

function sortTable(col) {

  if (currentSortColumn === col) {
    sortAscending = !sortAscending;
  } else {
    currentSortColumn = col;
    sortAscending = true;
  }

  const headerName = headers[col].toLowerCase();

  tableData.sort((a,b)=>{

    let A = a[col];
    let B = b[col];

    if(!A) A = "";
    if(!B) B = "";

    /* HEIGHT */
    if(headerName.includes("height")){
      A = parseHeight(A);
      B = parseHeight(B);
      return sortAscending ? A-B : B-A;
    }

    /* HAND / ARM */
    if(headerName.includes("hand") || headerName.includes("arm")){
      A = parseMeasurement(A);
      B = parseMeasurement(B);
      return sortAscending ? A-B : B-A;
    }

    /* GENERAL NUMBERS */
    if(!isNaN(parseFloat(A)) && !isNaN(parseFloat(B))){
      return sortAscending
        ? parseFloat(A) - parseFloat(B)
        : parseFloat(B) - parseFloat(A);
    }

    /* TEXT (School now works correctly) */
    return sortAscending
      ? A.toString().localeCompare(B.toString())
      : B.toString().localeCompare(A.toString());
  });

  displayRows();
}

function updateArrows(){
  document.querySelectorAll("#data-table th").forEach((th,i)=>{
    const arrow = th.querySelector(".arrow");
    arrow.textContent = i===currentSortColumn
      ? (sortAscending ? "▲" : "▼")
      : "";
  });
}

function highlightColumn(){
  document.querySelectorAll("td, th").forEach(cell=>{
    cell.classList.remove("sorted-column");
  });

  if(currentSortColumn === -1) return;

  document.querySelectorAll("#data-table tr").forEach(row=>{
    if(row.children[currentSortColumn]){
      row.children[currentSortColumn].classList.add("sorted-column");
    }
  });
}

function populateFilter(){
  if(posIndex === -1) return;

  const set = new Set();
  tableData.forEach(r=>set.add(r[posIndex]));

  const filter = document.getElementById("positionFilter");

  set.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    filter.appendChild(opt);
  });

  filter.onchange = displayRows;
}

document.getElementById("searchBox").addEventListener("input", displayRows);

function displayRows(){
  const tbody = document.querySelector("#data-table tbody");
  tbody.innerHTML="";

  const pos = document.getElementById("positionFilter").value;
  const search = document.getElementById("searchBox").value.toLowerCase();

  tableData.forEach(r=>{
    if(posIndex !== -1 && pos !== "ALL" && r[posIndex] !== pos) return;
    if(search && !r.join(" ").toLowerCase().includes(search)) return;

    const tr=document.createElement("tr");

    r.forEach((c)=>{
      const td=document.createElement("td");
      td.textContent=c;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  highlightColumn();
}
</script>
